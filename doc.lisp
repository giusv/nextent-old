(defprim text (template &rest args)
  (:pretty () `(text (:template ,template :args ,args)))
  (:output (indent) ()))

(defprim empty ()
  (:pretty () `(empty))
  (:output (indent) ())
  (:string (indent) ())
  (:doc () this)
  (:extent () 0))

(defprim nest (amount doc)
  (:pretty () `(nest (:amount ,amount :doc ,(synth :pretty doc))))
  (:output (indent) (synth :output doc (+ indent amount)))
  (:string (indent) (with-output-to-string (*standard-output*)
			(synth :output this indent)))
  (:doc () this)
  (:extent () (+ amount (synth :extent doc))))

(defprim text (template &rest args)
  (:pretty () `(text (:template ,template :args ,args)))
  (:output (indent) (format t "~v,0t~?" indent template args))
  (:string (indent) (with-output-to-string (*standard-output*)
		      (synth :output this indent)))
  (:doc () this)
  (:extent () (length (apply #'format nil template args))))

(defprim vcat (&rest docs)
  (:pretty () `(vcat (:docs ,(synth-all :pretty docs))))
  (:output (indent) (let ((fdocs (flatten docs)))
		     (unless (null fdocs) 
		       (progn (synth :output (car fdocs) indent)
			      (unless (null (cdr fdocs)) 
				(progn (format t "~%"))
				(synth :output (apply #'vcat (cdr fdocs)) indent))))))
  (:string (indent) (with-output-to-string (*standard-output*)
			(synth :output this indent)))
  (:doc () this)  
  (:extent () (let ((fdocs (flatten docs)))
		     (synth :extent (car (last fdocs))))))

(defprim hcat (&rest docs)
  (:pretty () `(hcat (:docs ,(synth-all :pretty docs))))
  (:output (indent) (let ((fdocs (flatten docs)))
		     (unless (null fdocs) 
		     	 (progn (synth :output (car fdocs) indent)
		     		(synth :output (apply #'hcat (cdr fdocs)) (+ indent (synth :extent (car fdocs))))))))
  (:string (indent) (with-output-to-string (*standard-output*)
			(synth :output this indent)))
  (:doc () (apply #'hcat docs))
  (:extent () (let ((fdocs (flatten docs)))
	       (reduce #'+ (synth-all :extent fdocs)))))


